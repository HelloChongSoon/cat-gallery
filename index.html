<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Cat Grid Example</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen">
  <h1 class="text-center text-2xl font-semibold text-white my-5">üê± Bryson's Cat Gallery üê±</h1>
  <div class="maincontent">
    <div id="status" class="hidden text-center px-3 py-2 mx-5 mb-2 rounded-lg text-green-300 bg-green-900/40 border border-green-700 text-sm">Fetching new cats‚Ä¶</div>
    <div id="grid" class="imgrid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 p-5 max-w-[1200px] mx-auto">
      <div class="loading text-center p-10 text-lg text-gray-300 col-span-full">Loading adorable cats...</div>
    </div>
  </div>

<script>
  // API base URL and desired image count
  const API_BASE = `https://api.thecatapi.com/v1/images/search`;
  const TARGET_COUNT = 24;

  function renderCats(data) {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    data.forEach((imageData, index) => {
      const image = document.createElement('img');
      image.src = imageData.url;
      image.alt = `Cat image ${index + 1}`;
      image.loading = 'lazy';
      image.className = 'w-full aspect-square object-cover rounded-lg';
      image.addEventListener('click', () => {
        window.open(imageData.url, '_blank');
      });
      const gridCell = document.createElement('div');
      gridCell.className = 'rounded-xl overflow-hidden bg-neutral-900 ring-1 ring-white/10 hover:ring-white/20 transition shadow-md hover:shadow-lg cursor-pointer';
      gridCell.appendChild(image);
      grid.appendChild(gridCell);
    });
  }

  function loadCats(options = { isRefresh: false }) {
    const { isRefresh } = options;
    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    if (isRefresh) {
      status.textContent = 'Fetching new cats‚Ä¶';
      status.classList.remove('hidden');
    } else {
      grid.innerHTML = '<div class="loading text-center p-10 text-lg text-gray-300 col-span-full">Loading adorable cats...</div>';
    }

    // If you have an API key, set it in localStorage as 'CAT_API_KEY'
    const apiKey = localStorage.getItem('CAT_API_KEY');

    // Helper to fetch a page with a specific limit
    const fetchPage = (limit) => {
      const url = `${API_BASE}?limit=${limit}`;
      const opts = apiKey ? { headers: { 'x-api-key': apiKey } } : {};
      return fetch(url, opts).then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      });
    };

    // Strategy:
    // - With API key: single request for TARGET_COUNT
    // - Without key: batch multiple requests (max ~10 per request) until we hit TARGET_COUNT
    const performFetch = async () => {
      if (apiKey) {
        return fetchPage(TARGET_COUNT);
      }
      const maxPerRequest = 10;
      const neededBatches = Math.ceil(TARGET_COUNT / maxPerRequest);
      const promises = Array.from({ length: neededBatches }, (_, i) => {
        const remaining = TARGET_COUNT - i * maxPerRequest;
        const thisLimit = Math.min(maxPerRequest, remaining);
        return fetchPage(thisLimit);
      });
      const results = await Promise.all(promises);
      return results.flat().slice(0, TARGET_COUNT);
    };

    performFetch()
      .then(data => {
        renderCats(data);
      })
      .catch(error => {
        console.error('Error fetching cats:', error);
        grid.innerHTML = '<div class="error text-center p-10 text-lg text-red-300 col-span-full">Failed to load cats. Please try again.</div>';
      })
      .finally(() => {
        if (isRefresh) {
          status.classList.add('hidden');
        }
      });
  }

  // Initial load
  loadCats();

  // Auto-refresh every 30 minutes
  setInterval(() => {
    loadCats({ isRefresh: true });
  }, 30 * 60 * 1000);
</script>
</body>
</html>
